name: Update All Mihomo Rules (.mrs)

on:
  schedule:
    - cron: '0 22 * * *' # åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r .tag_name)
          echo "Downloading Mihomo $LATEST_VERSION..."
          wget "https://github.com/MetaCubeX/mihomo/releases/download/$LATEST_VERSION/mihomo-linux-amd64-$LATEST_VERSION.gz" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Convert Upstream Rules
        run: |
          git clone --depth 1 https://github.com/Accademia/Additional_Rule_For_Clash.git upstream
          
          find upstream -type f -name "*.yaml" | while read source_file; do
            rel_path=${source_file#upstream/}
            dir_name=$(dirname "$rel_path")
            base_name=$(basename "$source_file" .yaml)

            target_dir="rules/$dir_name"
            mkdir -p "$target_dir"

            rule_type="domain"
            if [[ "$base_name" == *"IP"* ]] || [[ "$base_name" == *"ip"* ]]; then
              rule_type="ipcidr"
            fi

            target_file="$target_dir/$base_name.mrs"
            echo "ğŸ”„ Converting: $rel_path -> $target_file (Type: $rule_type)"
            ./mihomo convert-ruleset $rule_type yaml "$source_file" "$target_file" || echo "âš ï¸ Failed: $source_file"
          done

      - name: Convert Google Voice (self ruleset)
        run: |
          # æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† set -e å’Œ git æäº¤å‘½ä»¤
          SELF_DIR="self/google"
          mkdir -p "$SELF_DIR"

          SRC_URL="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/GoogleVoice/GoogleVoice.list"
          RAW_FILE="$SELF_DIR/GoogleVoice.raw"
          CLEAN_FILE="$SELF_DIR/GoogleVoice.clean"
          TARGET_FILE="$SELF_DIR/GoogleVoice.mrs"

          echo "â¬‡ï¸ Downloading Google Voice rule..."
          curl -fsSL "$SRC_URL" -o "$RAW_FILE"

          echo "ğŸ§¹ Cleaning invalid lines..."
          grep -E '^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD),' "$RAW_FILE" > "$CLEAN_FILE"

          echo "ğŸ”„ Converting to .mrs (domain behavior)..."
          ./mihomo convert-ruleset domain text "$CLEAN_FILE" "$TARGET_FILE"

          echo "âœ… Google Voice mrs generated: $TARGET_FILE"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œåªä¿ç•™ .mrs
          rm "$RAW_FILE" "$CLEAN_FILE"

      - name: Cleanup Binaries
        run: |
          rm mihomo
          rm -rf upstream

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ ç”Ÿæˆçš„è§„åˆ™ç›®å½•
          git add rules self
          
          # æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected. Skipping commit."
            exit 0
          else
            echo "âœ… Changes detected. Committing..."
            git commit -m "Auto-update rules: $(date +'%Y-%m-%d')"
            git push
          fi
