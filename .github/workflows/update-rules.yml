name: Update All Mihomo Rules (.mrs)

on:
  schedule:
    - cron: '0 22 * * *' # åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r .tag_name)
          echo "Downloading Mihomo $LATEST_VERSION..."
          wget "https://github.com/MetaCubeX/mihomo/releases/download/$LATEST_VERSION/mihomo-linux-amd64-$LATEST_VERSION.gz" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Clone Upstream & Convert
        run: |
          # 1. å…‹éš†ä¸Šæ¸¸ä»“åº“åˆ°ä¸´æ—¶ç›®å½• 'upstream'
          git clone --depth 1 https://github.com/Accademia/Additional_Rule_For_Clash.git upstream

          # 2. æ¸…ç†æ—§è§„åˆ™ï¼ˆå¯é€‰ï¼Œä¿ç•™ç›®å½•ç»“æž„ä»¥å…gitæŠ¥é”™ï¼Œæˆ–è€…ç›´æŽ¥ä¾é è¦†ç›–ï¼‰
          # mkdir -p rules 

          # 3. éåŽ†ä¸Šæ¸¸æ‰€æœ‰ yaml æ–‡ä»¶
          find upstream -type f -name "*.yaml" | while read source_file; do
            # èŽ·å–ç›¸å¯¹è·¯å¾„ (ä¾‹å¦‚: GeositeCN/GeositeCN_Domain.yaml)
            rel_path=${source_file#upstream/}
            
            # èŽ·å–ç›®å½•åå’Œæ–‡ä»¶å
            dir_name=$(dirname "$rel_path")
            base_name=$(basename "$rel_path" .yaml)
            
            # å‡†å¤‡ç›®æ ‡ç›®å½•
            target_dir="rules/$dir_name"
            mkdir -p "$target_dir"
            
            # 4. åˆ¤æ–­è§„åˆ™ç±»åž‹ (æ ¹æ®æ–‡ä»¶åçŒœæµ‹)
            # é»˜è®¤è§†ä¸º domainï¼Œå¦‚æžœæ–‡ä»¶ååŒ…å« 'IP' æˆ– 'ip' åˆ™è§†ä¸º ipcidr
            rule_type="domain"
            if [[ "$base_name" == *"IP"* ]] || [[ "$base_name" == *"ip"* ]]; then
              rule_type="ipcidr"
            fi
            
            # 5. æ‰§è¡Œè½¬æ¢
            target_file="$target_dir/$base_name.mrs"
            echo "ðŸ”„ Converting: $rel_path -> $target_file (Type: $rule_type)"
            
            # è¿è¡Œè½¬æ¢å‘½ä»¤ï¼Œå¦‚æžœå¤±è´¥ä¸ä¸­æ–­è„šæœ¬ä½†ä¼šè¾“å‡ºé”™è¯¯
            ./mihomo convert-ruleset $rule_type yaml "$source_file" "$target_file" || echo "âš ï¸ Failed: $source_file"
          done

      - name: Convert Google Voice (self ruleset)
        run: |
          set -e

          SELF_DIR="self/google"
          mkdir -p "$SELF_DIR"

          SRC_URL="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/GoogleVoice/GoogleVoice.list"
          RAW_FILE="$SELF_DIR/GoogleVoice.raw"
          CLEAN_FILE="$SELF_DIR/GoogleVoice.clean"
          TARGET_FILE="$SELF_DIR/GoogleVoice.mrs"

          echo "â¬‡ï¸ Downloading Google Voice rule..."
          curl -fsSL "$SRC_URL" -o "$RAW_FILE"

          echo "ðŸ§¹ Cleaning invalid lines..."
          grep -E '^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD),' "$RAW_FILE" > "$CLEAN_FILE"

          echo "ðŸ”„ Converting to .mrs (domain behavior)..."
          ./mihomo convert-ruleset domain text "$CLEAN_FILE" "$TARGET_FILE"

          echo "âœ… Google Voice mrs generated: $TARGET_FILE"


      - name: Cleanup
        run: |
          rm mihomo
          rm -rf upstream

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Sync all rules to .mrs [$(date +'%Y-%m-%d')]"
          file_pattern: |
            rules/
            self/
          add: true

